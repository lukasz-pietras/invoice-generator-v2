<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator faktur</title>
    <style>
      :root {
        --gap: 20px;
        --radius: 12px;
        --border: #e5e7eb;
        --panel: #ffffff;
        --bg: #f5f6fa;
        --primary: #2563eb;
        --primary-soft: rgba(37, 99, 235, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        background: var(--bg);
        color: #1f2937;
      }

      h1,
      h2 {
        margin: 0;
      }

      p {
        margin: 0 0 8px;
        color: #6b7280;
      }

      .app {
        display: flex;
        gap: var(--gap);
        padding: var(--gap);
        min-height: 100vh;
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(15, 23, 42, 0.05);
        display: flex;
        flex-direction: column;
      }

      .panel.form {
        width: 45%;
        padding: var(--gap);
        gap: var(--gap);
        overflow-y: auto;
        max-height: calc(100vh - 2 * var(--gap));
      }

      .panel.preview {
        flex: 1;
        padding: var(--gap);
        overflow-y: auto;
        max-height: calc(100vh - 2 * var(--gap));
      }

      .section {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .inline {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .party-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .party-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .party-card h3 {
        margin: 0;
        font-size: 1rem;
      }

      .party-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .party-controls select {
        flex: 1;
      }

      .section h2 {
        font-size: 1.05rem;
      }

      .grid {
        display: grid;
        gap: 12px;
      }

      .grid.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid.three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      @media (max-width: 900px) {
        .grid.three {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 640px) {
        .grid.three {
          grid-template-columns: 1fr;
        }
      }

      .note-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .note-buttons .btn {
        justify-content: flex-start;
        align-items: flex-start;
        text-align: left;
        white-space: normal;
        line-height: 1.4;
      }

      .exchange-rate-card {
        border: 1px solid #dbeafe;
        background: rgba(219, 234, 254, 0.45);
        border-radius: 10px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .exchange-rate-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .exchange-rate-info {
        font-size: 0.85rem;
        color: #374151;
      }

      .exchange-rate-muted {
        font-size: 0.8rem;
        color: #6b7280;
      }

      .exchange-rate-error {
        font-size: 0.85rem;
        color: #dc2626;
      }

      label {
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      input,
      select,
      textarea {
        font-family: inherit;
        padding: 9px 11px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 0.95rem;
        background: #f9fafb;
        transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-soft);
        background: #fff;
      }

      textarea {
        resize: vertical;
        min-height: 90px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 9px 16px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
      }

      .btn-secondary {
        background: #eef2ff;
        color: #1e3a8a;
        border: 1px solid rgba(37, 99, 235, 0.2);
      }

      .btn-ghost {
        background: transparent;
        color: #ef4444;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .logo-box {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px dashed var(--border);
        padding: 10px;
      }

      .logo-box img {
        max-height: 70px;
        max-width: 100%;
        object-fit: contain;
      }

      .saved-row {
        display: flex;
        gap: 8px;
      }

      .saved-row select {
        flex: 1;
      }

      .saved-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .items {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .item-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .item-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .preview header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .paper {
        background: white;
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 32px;
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.1);
        width: 210mm;
        min-height: 297mm;
        box-sizing: border-box;
        margin: 0 auto;
        font-size: 13px;
        line-height: 1.45;
      }

      .pair {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .info-box {
        background: #f9fafb;
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 10px;
        padding: 14px;
      }

      .info-box h3 {
        margin: 0 0 6px;
        font-size: 0.82rem;
        text-transform: uppercase;
        color: #6b7280;
        letter-spacing: 0.05em;
      }

      .info-box p {
        margin: 0;
        color: #1f2937;
        line-height: 1.45;
        font-size: 0.85rem;
      }

      .details-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px 16px;
        background: #f3f4f6;
        border: 1px solid #dbe1ea;
        border-radius: 10px;
        padding: 14px 16px;
        margin: 16px 0 14px;
      }

      .details-label {
        margin: 0 0 4px;
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #6b7280;
      }

      .details-value {
        margin: 0;
        font-size: 0.8rem;
        font-weight: 600;
        color: #1f2937;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.55rem;
        table-layout: fixed;
      }

      th,
      td {
        border: 1px solid #dbe1ea;
        padding: 8px 10px;
        text-align: left;
      }

      th {
        background: #eef2ff;
        font-weight: 600;
      }

      td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .summary {
        margin-top: 18px;
        display: grid;
        gap: 8px;
      }

      .summary-heading {
        margin: 0;
        font-weight: 600;
        font-size: 0.65rem;
        color: #374151;
      }

      .totals-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .totals-card {
        border: 1px solid #dbe1ea;
        border-radius: 10px;
        background: #f3f4f6;
        padding: 12px 14px;
      }

      .totals-card--highlight {
        background: rgba(37, 99, 235, 0.08);
        border-color: rgba(37, 99, 235, 0.25);
      }

      .totals-label {
        margin: 0;
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #6b7280;
      }

      .totals-value {
        margin: 6px 0 0;
        font-size: 0.8rem;
        font-weight: 600;
        color: #1f2937;
      }


      .summary div strong {
        font-weight: 700;
      }

      .notes {
        margin-top: 18px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        padding: 14px;
        min-height: 60px;
        background: #f9fafb;
        font-size: 0.55rem;
      }

      @media (max-width: 1200px) {
        .app {
          flex-direction: column;
        }

        .panel.form,
        .panel.preview {
          width: 100%;
          max-height: none;
        }
      }

      @media print {
        body {
          background: white;
        }
        .app,
        .panel.form,
        .panel.preview {
          display: block;
        }
        .panel.form {
          display: none;
        }
        .panel.preview {
          padding: 0;
          box-shadow: none;
        }
        .paper {
          box-shadow: none;
          border: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="panel form" id="form-panel">
        <header>
          <h1>Generator faktur</h1>
          <p>
            Wypelnij dane sprzedawcy, nabywcy i pozycje, aby uzyskac gotowa
            fakture.
          </p>
        </header>

        <div class="section" aria-labelledby="invoice-info">
          <h2 id="invoice-info">Dane faktury</h2>
          <div class="grid two">
            <label>
              Numer faktury
              <input type="text" data-field="invoiceNumber" placeholder="FV/01/2025" />
            </label>
            <label>
              Waluta
              <select data-field="currency">
                <option value="PLN">PLN</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
              </select>
            </label>
            <label>
              Data wystawienia
              <input type="date" data-field="issueDate" />
            </label>
            <label>
              Data sprzedazy
              <input type="date" data-field="saleDate" />
            </label>
            <label>
              Termin platnosci
              <input type="date" data-field="paymentDeadline" />
            </label>
            <label>
              Metoda platnosci
              <select data-field="paymentMethod">
                <option value="Przelew">Przelew</option>
                <option value="Gotowka">Gotowka</option>
                <option value="Karta">Karta</option>
              </select>
            </label>
          </div>
          <div class="exchange-rate-card" id="exchange-rate-card" hidden>
            <label>
              Data kursu NBP
              <input
                type="date"
                id="exchange-rate-date"
                data-field="exchangeRate.targetDate"
                min="2002-01-02"
              />
            </label>
            <p class="exchange-rate-muted">
              Domyslnie pobieramy kurs sredni z poprzedniego dnia roboczego.
            </p>
            <div class="exchange-rate-actions">
              <button type="button" class="btn btn-secondary" data-action="rate-prev-day">
                Poprzedni dzien roboczy
              </button>
              <button type="button" class="btn btn-secondary" data-action="rate-refresh">
                Odswiez kurs
              </button>
            </div>
            <p class="exchange-rate-info" id="exchange-rate-info"></p>
            <p class="exchange-rate-error" id="exchange-rate-error" style="display:none;"></p>
            <p class="exchange-rate-muted" id="exchange-rate-warning" style="display:none;"></p>
          </div>
        </div>

        <div class="section" aria-labelledby="logo">
          <div class="saved-row" style="justify-content: space-between">
            <h2 id="logo" style="margin:0;">Logo</h2>
            <button class="btn btn-secondary" id="logo-btn" type="button">
              Dodaj / zmien
            </button>
          </div>
          <input type="file" id="logo-input" accept="image/*" hidden />
          <div class="logo-box" id="logo-preview">Brak logo</div>
        </div>

        <div class="section" aria-labelledby="parties">
          <div class="section-head">
            <h2 id="parties">Kontrahenci</h2>
            <div class="inline">
              <button class="btn btn-secondary" type="button" id="import-btn">
                Wczytaj
              </button>
              <button class="btn btn-secondary" type="button" id="export-btn">
                Eksportuj
              </button>
            </div>
          </div>
          <div class="party-grid">
            <div class="party-card" aria-labelledby="seller-heading">
              <h3 id="seller-heading">Sprzedawca</h3>
              <div class="party-controls">
                <select id="seller-select">
                  <option value="">Wybierz zapisane dane</option>
                </select>
                <button class="btn btn-secondary" type="button" data-action="save-seller">
                  Zapisz
                </button>
              </div>
              <div class="grid" data-party="seller">
                <label data-field-container="seller.name">
                  <span class="field-label" data-label="seller.name">Company name</span>
                  <input type="text" data-field="seller.name" placeholder="Company name" />
                </label>
                <label data-field-container="seller.country">
                  <span class="field-label" data-label="seller.country">Country</span>
                  <select data-field="seller.country">
                    <option value="USA" selected>United States</option>
                    <option value="POL">Polska</option>
                  </select>
                </label>
                <label data-field-container="seller.address">
                  <span class="field-label" data-label="seller.address">Street address</span>
                  <input type="text" data-field="seller.address" placeholder="123 Main St" />
                </label>
                <div class="grid three location-grid" data-field-container="seller.location">
                  <label data-field-container="seller.postalCode">
                    <span class="field-label" data-label="seller.postalCode">ZIP Code</span>
                    <input type="text" data-field="seller.postalCode" placeholder="12345" inputmode="numeric" />
                  </label>
                  <label data-field-container="seller.city">
                    <span class="field-label" data-label="seller.city">City</span>
                    <input type="text" data-field="seller.city" placeholder="City" />
                  </label>
                  <label data-field-container="seller.state">
                    <span class="field-label" data-label="seller.state">State</span>
                    <input type="text" data-field="seller.state" placeholder="CA" />
                  </label>
                </div>
                <label data-field-container="seller.nip">
                  <span class="field-label" data-label="seller.nip">Tax ID (EIN)</span>
                  <input type="text" data-field="seller.nip" placeholder="12-3456789" />
                </label>
                <label data-field-container="seller.bankAccount">
                  <span class="field-label" data-label="seller.bankAccount">Bank account</span>
                  <input type="text" data-field="seller.bankAccount" placeholder="Account number" />
                </label>
              </div>
            </div>
            <div class="party-card" aria-labelledby="buyer-heading">
              <h3 id="buyer-heading">Nabywca</h3>
              <div class="party-controls">
                <select id="buyer-select">
                  <option value="">Wybierz zapisane dane</option>
                </select>
                <button class="btn btn-secondary" type="button" data-action="save-buyer">
                  Zapisz
                </button>
              </div>
              <div class="grid" data-party="buyer">
                <label data-field-container="buyer.name">
                  <span class="field-label" data-label="buyer.name">Company name</span>
                  <input type="text" data-field="buyer.name" placeholder="Company name" />
                </label>
                <label data-field-container="buyer.country">
                  <span class="field-label" data-label="buyer.country">Country</span>
                  <select data-field="buyer.country">
                    <option value="USA" selected>United States</option>
                    <option value="POL">Polska</option>
                  </select>
                </label>
                <label data-field-container="buyer.address">
                  <span class="field-label" data-label="buyer.address">Street address</span>
                  <input type="text" data-field="buyer.address" placeholder="123 Main St" />
                </label>
                <div class="grid three location-grid" data-field-container="buyer.location">
                  <label data-field-container="buyer.postalCode">
                    <span class="field-label" data-label="buyer.postalCode">ZIP Code</span>
                    <input type="text" data-field="buyer.postalCode" placeholder="12345" inputmode="numeric" />
                  </label>
                  <label data-field-container="buyer.city">
                    <span class="field-label" data-label="buyer.city">City</span>
                    <input type="text" data-field="buyer.city" placeholder="City" />
                  </label>
                  <label data-field-container="buyer.state">
                    <span class="field-label" data-label="buyer.state">State</span>
                    <input type="text" data-field="buyer.state" placeholder="CA" />
                  </label>
                </div>
                <label data-field-container="buyer.nip">
                  <span class="field-label" data-label="buyer.nip">Tax ID (EIN)</span>
                  <input type="text" data-field="buyer.nip" placeholder="12-3456789" />
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="section" aria-labelledby="items">
          <div class="item-head">
            <h2 id="items">Pozycje</h2>
            <button class="btn btn-primary" type="button" id="add-item">
              Dodaj pozycje
            </button>
          </div>
          <div class="items" id="items-container"></div>
        </div>

        <div class="section" aria-labelledby="notes">
          <h2 id="notes">Uwagi</h2>
          <textarea data-field="notes" placeholder="Dodatkowe informacje dla nabywcy"></textarea>
          <div class="note-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              data-note="Zwolnienie z VAT na podstawie art. 113 ust. 1 ustawy o VAT."
            >
              Zwolnienie z VAT na podstawie art. 113 ust. 1 ustawy o VAT.
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-note="Usługa nie podlega opodatkowaniu VAT w Polsce — miejsce świadczenia poza terytorium UE (art. 28b ustawy o VAT)."
            >
              Usługa nie podlega opodatkowaniu VAT w Polsce — miejsce świadczenia poza terytorium UE (art. 28b ustawy o VAT).
            </button>
          </div>
        </div>
      </section>

      <section class="panel preview">
        <header>
          <h1>Podglad faktury</h1>
          <button class="btn btn-primary" type="button" id="download-btn">
            Pobierz / wydrukuj
          </button>
        </header>
        <div class="paper" id="preview">
          <!-- dynamic preview -->
        </div>
      </section>
    </div>
    <template id="item-template">
      <div class="item-card" data-card>
        <div class="item-head">
          <strong>Pozycja <span data-index></span></strong>
          <button class="btn btn-ghost" type="button" data-remove>Usun</button>
        </div>
        <div class="grid">
          <label>
            Nazwa
            <input type="text" data-item="name" placeholder="Produkt / usluga" />
          </label>
          <div class="grid two">
            <label>
              Ilosc
              <input type="number" min="0" step="0.01" data-item="quantity" />
            </label>
            <label>
              Jednostka
              <input type="text" data-item="unit" list="unit-list" />
            </label>
          </div>
          <div class="grid two">
            <label>
              Cena netto
              <input type="number" min="0" step="0.01" data-item="netPrice" />
            </label>
            <label>
              VAT
              <select data-item="vatRate">
                <option value="23">23%</option>
                <option value="8">8%</option>
                <option value="5">5%</option>
                <option value="0">0%</option>
                <option value="-1">ZW</option>
                <option value="-2">NP</option>
                <option value="-3">OO</option>
              </select>
            </label>
          </div>
        </div>
      </div>
    </template>

    <datalist id="unit-list">
      <option value="szt."></option>
      <option value="kg"></option>
      <option value="m"></option>
      <option value="m2"></option>
      <option value="godz."></option>
      <option value="usl."></option>
    </datalist>

    <script>
      const defaultState = {
        invoiceNumber: "",
        issueDate: new Date().toISOString().split("T")[0],
        saleDate: new Date().toISOString().split("T")[0],
        paymentDeadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000)
          .toISOString()
          .split("T")[0],
        paymentMethod: "Przelew",
        currency: "PLN",
        seller: {
          name: "",
          country: "USA",
          address: "",
          postalCode: "",
          city: "",
          state: "",
          nip: "",
          bankAccount: "",
        },
        buyer: {
          name: "",
          country: "USA",
          address: "",
          postalCode: "",
          city: "",
          state: "",
          nip: "",
        },
        items: [
          {
            id: "1",
            name: "",
            quantity: 1,
            unit: "szt.",
            netPrice: 0,
            vatRate: 23,
          },
        ],
        notes: "",
        logo: null,
        exchangeRate: {
          targetDate: "",
          effectiveDate: "",
          value: null,
        },
      };

      let state = clone(defaultState);
      const STORAGE_KEY = "invoiceCompanies";
      const storageSnapshot = loadStoredData();
      const storedData = {
        seller: storageSnapshot.data.seller || {},
        buyer: storageSnapshot.data.buyer || {},
      };
      const DEFAULT_COUNTRY = "USA";
      const COUNTRY_ALIASES = {
        US: "USA",
        "U.S.": "USA",
        "U.S.A.": "USA",
        "UNITED STATES": "USA",
        "UNITED STATES OF AMERICA": "USA",
        AMERICA: "USA",
        PL: "POL",
        POLAND: "POL",
        "RZECZPOSPOLITA POLSKA": "POL",
      };
      const COUNTRY_CONFIG = {
        USA: {
          code: "USA",
          label: "United States",
          countryName: "United States",
          fieldLabels: {
            name: "Company name",
            country: "Country",
            address: "Street address",
            postalCode: "ZIP Code",
            city: "City",
            state: "State",
            nip: "Tax ID (EIN)",
            bankAccount: "Bank account",
          },
          placeholders: {
            name: "Company name",
            country: "United States",
            address: "123 Main St",
            postalCode: "12345",
            city: "New York",
            state: "NY",
            nip: "12-3456789",
            bankAccount: "Account number",
          },
          postalPattern: "^\\d{5}(?:-\\d{4})?$",
          postalInputMode: "numeric",
          showState: true,
          requireState: true,
          showCountryLine: true,
          showBankAccount: true,
        },
        POL: {
          code: "POL",
          label: "Polska",
          countryName: "Polska",
          fieldLabels: {
            name: "Nazwa",
            country: "Kraj",
            address: "Adres",
            postalCode: "Kod pocztowy",
            city: "Miasto",
            state: "Województwo",
            nip: "NIP",
            bankAccount: "Numer konta",
          },
          placeholders: {
            name: "Nazwa",
            country: "Polska",
            address: "Ulica i numer",
            postalCode: "00-000",
            city: "Miasto",
            state: "",
            nip: "0000000000",
            bankAccount: "00 0000 0000 0000 0000 0000 0000",
          },
          postalPattern: "^\\d{2}-\\d{3}$",
          postalInputMode: "text",
          showState: false,
          requireState: false,
          showCountryLine: false,
          showBankAccount: true,
        },
      };
      if (storageSnapshot.migrated) {
        persistStorage();
      }

      const itemTemplate = document.getElementById("item-template");
      const itemsContainer = document.getElementById("items-container");
      const preview = document.getElementById("preview");
      const logoPreview = document.getElementById("logo-preview");
      const exchangeRateCard = document.getElementById("exchange-rate-card");
      const exchangeRateDateInput = document.getElementById("exchange-rate-date");
      const exchangeRateInfo = document.getElementById("exchange-rate-info");
      const exchangeRateError = document.getElementById("exchange-rate-error");
      const exchangeRateWarning = document.getElementById("exchange-rate-warning");
      let rateStatus = { loading: false, error: null };
      let rateRequestId = 0;

      function clone(data) {
        return JSON.parse(JSON.stringify(data));
      }

      function loadStoredData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            return {
              data: {
                seller: normalizeRecord(parsed.seller, "seller"),
                buyer: normalizeRecord(parsed.buyer, "buyer"),
              },
              migrated: false,
            };
          }
        } catch (error) {
          console.warn("Nie udalo sie odczytac", error);
        }

        const legacySeller = readLegacy("savedSellers", "seller");
        const legacyBuyer = readLegacy("savedBuyers", "buyer");
        const migrated =
          Object.keys(legacySeller).length > 0 || Object.keys(legacyBuyer).length > 0;

        return {
          data: {
            seller: legacySeller,
            buyer: legacyBuyer,
          },
          migrated,
        };
      }

      function parseISODate(dateString) {
        if (!dateString) return null;
        const parts = dateString.split("-").map(Number);
        if (parts.length !== 3) return null;
        const [year, month, day] = parts;
        if (
          Number.isNaN(year) ||
          Number.isNaN(month) ||
          Number.isNaN(day)
        ) {
          return null;
        }
        return new Date(Date.UTC(year, month - 1, day));
      }

      function toDateString(date) {
        return date.toISOString().split("T")[0];
      }

      function getPreviousBusinessDay(referenceDate) {
        const parsed = parseISODate(referenceDate);
        const now = new Date();
        const base = parsed ?? new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        const date = new Date(Date.UTC(base.getUTCFullYear(), base.getUTCMonth(), base.getUTCDate()));
        date.setUTCDate(date.getUTCDate() - 1);
        while (date.getUTCDay() === 0 || date.getUTCDay() === 6) {
          date.setUTCDate(date.getUTCDate() - 1);
        }
        return toDateString(date);
      }

      function shiftDateString(dateString, offset) {
        const [year, month, day] = dateString.split("-").map(Number);
        const date = new Date(Date.UTC(year, month - 1, day));
        date.setUTCDate(date.getUTCDate() + offset);
        return toDateString(date);
      }

      function sanitizeRateDate(value) {
        if (!value) return "";
        const max = getPreviousBusinessDay(state.issueDate);
        return value > max ? max : value;
      }

      async function fetchExchangeRateWithFallback(targetDate, currency) {
        let lookupDate = targetDate;
        let attempts = 0;
        const maxAttempts = 10;

        while (attempts < maxAttempts) {
          const response = await fetch(
            `https://api.nbp.pl/api/exchangerates/rates/A/${currency}/${lookupDate}/?format=json`,
            { headers: { Accept: "application/json" } }
          );

          if (response.status === 404) {
            lookupDate = shiftDateString(lookupDate, -1);
            attempts += 1;
            continue;
          }

          if (!response.ok) {
            throw new Error("Nie udalo sie pobrac kursu NBP.");
          }

          const data = await response.json();
          const rate = data?.rates?.[0];
          if (!rate || typeof rate.mid !== "number") {
            throw new Error("Brak danych kursu NBP dla wskazanej daty.");
          }

          return { value: rate.mid, effectiveDate: rate.effectiveDate };
        }

        throw new Error("Brak kursu NBP dla wybranej daty w ostatnich dniach roboczych.");
      }

      function updateExchangeRateUI() {
        if (!exchangeRateCard) return;
        const normalizedCurrency = (state.currency || "").trim().toUpperCase();
        const isForeign = normalizedCurrency && normalizedCurrency !== "PLN";
        exchangeRateCard.hidden = !isForeign;
        exchangeRateCard.style.display = isForeign ? "" : "none";

        if (exchangeRateDateInput) {
          exchangeRateDateInput.max = getPreviousBusinessDay(state.issueDate);
          exchangeRateDateInput.value = state.exchangeRate.targetDate || "";
        }

        if (!isForeign) {
          if (exchangeRateInfo) exchangeRateInfo.textContent = "";
          if (exchangeRateError) exchangeRateError.style.display = "none";
          if (exchangeRateWarning) exchangeRateWarning.style.display = "none";
          return;
        }

        if (rateStatus.loading) {
          if (exchangeRateInfo) exchangeRateInfo.textContent = "Pobieranie kursu z NBP...";
        } else if (state.exchangeRate.value !== null && state.exchangeRate.effectiveDate) {
          if (exchangeRateInfo) {
            exchangeRateInfo.textContent = `Kurs sredni NBP (tabela A) z dnia ${state.exchangeRate.effectiveDate}: ${state.exchangeRate.value.toFixed(4)} PLN.`;
          }
        } else {
          if (exchangeRateInfo) {
            exchangeRateInfo.textContent = "Wybierz date, aby pobrac kurs sredni z NBP.";
          }
        }

        if (exchangeRateError) {
          if (rateStatus.error) {
            exchangeRateError.style.display = "block";
            exchangeRateError.textContent = rateStatus.error;
          } else {
            exchangeRateError.style.display = "none";
            exchangeRateError.textContent = "";
          }
        }

        if (exchangeRateWarning) {
          if (
            state.exchangeRate.targetDate &&
            state.exchangeRate.effectiveDate &&
            state.exchangeRate.targetDate !== state.exchangeRate.effectiveDate
          ) {
            exchangeRateWarning.style.display = "block";
            exchangeRateWarning.textContent = `Wybrana data nie byla dniem publikacji tabeli. Uzyto kursu z ${state.exchangeRate.effectiveDate}.`;
          } else {
            exchangeRateWarning.style.display = "none";
            exchangeRateWarning.textContent = "";
          }
        }
      }

      async function ensureExchangeRate({ forceRefresh = false } = {}) {
        const normalizedCurrency = (state.currency || "").trim().toUpperCase();
        if (!normalizedCurrency || normalizedCurrency === "PLN") {
          state.exchangeRate = { targetDate: "", effectiveDate: "", value: null };
          rateStatus = { loading: false, error: null };
          updateExchangeRateUI();
          renderPreview();
          return;
        }

        if (!state.exchangeRate.targetDate) {
          state.exchangeRate.targetDate = getPreviousBusinessDay(state.issueDate);
        }

        if (
          !forceRefresh &&
          state.exchangeRate.value !== null &&
          state.exchangeRate.effectiveDate
        ) {
          updateExchangeRateUI();
          return;
        }

        if (!state.exchangeRate.targetDate) {
          updateExchangeRateUI();
          return;
        }

        rateRequestId += 1;
        const requestId = rateRequestId;
        rateStatus = { loading: true, error: null };
        updateExchangeRateUI();

        try {
          const result = await fetchExchangeRateWithFallback(
            state.exchangeRate.targetDate,
            normalizedCurrency
          );
          if (requestId !== rateRequestId) {
            return;
          }
          state.exchangeRate.value = result.value;
          state.exchangeRate.effectiveDate = result.effectiveDate;
          rateStatus = { loading: false, error: null };
          updateExchangeRateUI();
          renderPreview();
        } catch (error) {
          if (requestId !== rateRequestId) {
            return;
          }
          state.exchangeRate.value = null;
          state.exchangeRate.effectiveDate = "";
          rateStatus = {
            loading: false,
            error: error?.message || "Nie udalo sie pobrac kursu NBP.",
          };
          updateExchangeRateUI();
          renderPreview();
        }
      }

      function persistStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
          localStorage.removeItem("savedSellers");
          localStorage.removeItem("savedBuyers");
        } catch (error) {
          console.warn("Nie udalo sie zapisac", error);
        }
      }

      function readLegacy(key, type) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return normalizeRecord(parsed, type);
        } catch (error) {
          console.warn("Nie udalo sie odczytac z legacy", error);
        }
        return {};
      }

      function normalizeRecord(input, type) {
        if (!input) return {};
        if (Array.isArray(input)) {
          const map = {};
          input.forEach((entry) => {
            if (!entry) return;
            if (entry.name) {
              const payload = entry.data ? { ...entry.data } : { ...entry };
              payload.name = payload.name || entry.name;
              map[entry.name] = normalizePartyRecord(payload, type);
            }
          });
          return map;
        }
        if (typeof input === "object") {
          const map = {};
          Object.entries(input).forEach(([key, value]) => {
            if (!value) return;
            const payload = value.data ? { ...value.data } : { ...value };
            payload.name = payload.name || key;
            map[key] = normalizePartyRecord(payload, type);
          });
          return map;
        }
        return {};
      }

      function normalizeCountry(value) {
        if (value === null || value === undefined) {
          return DEFAULT_COUNTRY;
        }
        const raw = String(value).trim().toUpperCase();
        if (!raw) {
          return DEFAULT_COUNTRY;
        }
        if (COUNTRY_CONFIG[raw]) {
          return raw;
        }
        if (COUNTRY_ALIASES[raw]) {
          return COUNTRY_ALIASES[raw];
        }
        return DEFAULT_COUNTRY;
      }

      function formatPostalCode(value, country) {
        if (value === null || value === undefined) {
          return "";
        }
        const normalizedCountry = normalizeCountry(country);
        const raw = String(value).trim();
        if (!raw) {
          return "";
        }
        if (normalizedCountry === "USA") {
          const digits = raw.replace(/\D/g, "").slice(0, 9);
          if (digits.length > 5) {
            return `${digits.slice(0, 5)}-${digits.slice(5)}`;
          }
          return digits;
        }
        if (normalizedCountry === "POL") {
          if (/^\d{2}-\d{3}$/.test(raw)) {
            return raw;
          }
          const digits = raw.replace(/\D/g, "").slice(0, 5);
          if (digits.length === 5) {
            return `${digits.slice(0, 2)}-${digits.slice(2)}`;
          }
          return digits;
        }
        return raw;
      }

      function formatStateValue(value, country) {
        if (value === null || value === undefined) {
          return "";
        }
        const normalizedCountry = normalizeCountry(country);
        const raw = String(value).trim();
        if (!raw) {
          return "";
        }
        if (normalizedCountry === "USA") {
          return raw.toUpperCase();
        }
        return raw;
      }

      function formatTaxId(value, country) {
        if (value === null || value === undefined) {
          return "";
        }
        const normalizedCountry = normalizeCountry(country);
        const raw = String(value).trim();
        if (!raw) {
          return "";
        }
        if (normalizedCountry === "USA") {
          const digits = raw.replace(/\D/g, "").slice(0, 9);
          if (digits.length <= 2) {
            return digits;
          }
          return `${digits.slice(0, 2)}-${digits.slice(2)}`;
        }
        return raw;
      }

      function normalizePartyRecord(input, type) {
        const record = input ? { ...input } : {};
        const normalized = {
          name: (record.name || "").toString().trim(),
          country:
            record.country ??
            record.countryCode ??
            record.country_code ??
            record.countryName ??
            record.country_name ??
            DEFAULT_COUNTRY,
          address: (record.address || "").toString().trim(),
          postalCode: (
            record.postalCode ??
            record.post_code ??
            record.zip ??
            record.zipCode ??
            record.zip_code ??
            ""
          )
            .toString()
            .trim(),
          city: (record.city || record.town || "").toString().trim(),
          state: (
            record.state ||
            record.stateCode ||
            record.state_code ||
            record.region ||
            record.province ||
            record.voivodeship ||
            ""
          )
            .toString()
            .trim(),
          nip: (
            record.nip ||
            record.taxId ||
            record.tax_id ||
            record.taxNumber ||
            record.tax_number ||
            record.vat ||
            record.vatId ||
            record.vat_id ||
            ""
          )
            .toString()
            .trim(),
        };
        normalized.country = normalizeCountry(normalized.country);
        if (
          !record.country &&
          normalized.country === DEFAULT_COUNTRY &&
          /^\d{2}-\d{3}$/.test(normalized.postalCode)
        ) {
          normalized.country = "POL";
        }
        if (
          !record.country &&
          normalized.country === DEFAULT_COUNTRY &&
          normalized.nip &&
          normalized.nip.replace(/\D/g, "").length === 10
        ) {
          normalized.country = "POL";
        }
        normalized.postalCode = formatPostalCode(normalized.postalCode, normalized.country);
        normalized.state = formatStateValue(normalized.state, normalized.country);
        normalized.nip = formatTaxId(normalized.nip, normalized.country);
        if (normalized.country === "POL" && !normalized.postalCode && normalized.address) {
          const match = normalized.address.match(/^(.*?)(\d{2}-\d{3})\s+(.+)$/);
          if (match) {
            normalized.address = match[1].trim();
            normalized.postalCode = match[2];
            if (!normalized.city) {
              normalized.city = match[3];
            }
          }
        }
        if (type === "seller") {
          normalized.bankAccount = (
            record.bankAccount ||
            record.account ||
            record.bank_account ||
            ""
          )
            .toString()
            .trim();
        }
        return normalized;
      }

      function getCountryConfig(countryCode) {
        const normalized = normalizeCountry(countryCode);
        return COUNTRY_CONFIG[normalized] || COUNTRY_CONFIG[DEFAULT_COUNTRY];
      }

      function formatPartyLocation(party) {
        const config = getCountryConfig(party?.country);
        const city = (party?.city || "").toString().trim();
        const stateValue = (party?.state || "").toString().trim();
        const postalCode = (party?.postalCode || "").toString().trim();
        if (config.code === "USA") {
          const cityPart = city;
          const stateZip = [stateValue, postalCode].filter(Boolean).join(" ").trim();
          if (cityPart && stateZip) {
            return `${cityPart}, ${stateZip}`.trim();
          }
          return cityPart || stateZip || "";
        }
        const parts = [postalCode, city].filter(Boolean);
        return parts.join(" ").trim();
      }

      function formatPartyCountryLine(party, { fallback = false } = {}) {
        const config = getCountryConfig(party?.country);
        if (!config.showCountryLine) {
          return "";
        }
        if (party?.country) {
          return config.countryName || config.label || normalizeCountry(party.country);
        }
        return fallback ? config.countryName || config.label || "" : "";
      }

      function buildPartyPreviewHtml(party, type) {
        const config = getCountryConfig(party?.country);
        const placeholders = config.placeholders || {};
        const name = (party?.name || "").toString().trim() || placeholders.name || "";
        const address = (party?.address || "").toString().trim() || placeholders.address || "";
        let location = formatPartyLocation(party);
        if (!location) {
          location = formatPartyLocation({
            country: config.code,
            city: placeholders.city,
            state: placeholders.state,
            postalCode: placeholders.postalCode,
          });
        }
        let countryLine = formatPartyCountryLine(party);
        if (!countryLine) {
          countryLine = formatPartyCountryLine(party, { fallback: true });
        }
        const taxLabel = config.fieldLabels?.nip || "Tax ID";
        const taxValue =
          (party?.nip || "").toString().trim() || placeholders.nip || "";
        const lines = [];
        if (name) lines.push(name);
        if (address) lines.push(address);
        if (location) lines.push(location);
        if (countryLine) lines.push(countryLine);
        lines.push(`${taxLabel}: ${taxValue}`);
        if (type === "seller") {
          const bankLabel = config.fieldLabels?.bankAccount || "Bank account";
          const bankValue = (party?.bankAccount || "").toString().trim();
          if (bankValue) {
            lines.push(`${bankLabel}: ${bankValue}`);
          }
        }
        return lines.join("<br/>");
      }

      function applyCountryFormatting(type) {
        const party = state[type];
        if (!party) return;
        party.country = normalizeCountry(party.country);
        party.postalCode = formatPostalCode(party.postalCode, party.country);
        party.state = formatStateValue(party.state, party.country);
        party.nip = formatTaxId(party.nip, party.country);
        const countryInput = document.querySelector(`[data-field='${type}.country']`);
        if (countryInput && countryInput.value !== party.country) {
          countryInput.value = party.country;
        }
        const postalInput = document.querySelector(`[data-field='${type}.postalCode']`);
        if (postalInput && postalInput.value !== party.postalCode) {
          postalInput.value = party.postalCode;
        }
        const stateInput = document.querySelector(`[data-field='${type}.state']`);
        if (stateInput && stateInput.value !== party.state) {
          stateInput.value = party.state;
        }
        const taxInput = document.querySelector(`[data-field='${type}.nip']`);
        if (taxInput && taxInput.value !== party.nip) {
          taxInput.value = party.nip;
        }
      }

      function updatePartyForm(type) {
        const party = state[type];
        if (!party) return;
        const config = getCountryConfig(party.country);
        const placeholders = config.placeholders || {};
        const labels = config.fieldLabels || {};
        const fields = ["name", "country", "address", "postalCode", "city", "state", "nip"];
        if (type === "seller") {
          fields.push("bankAccount");
        }
        fields.forEach((field) => {
          const labelElement = document.querySelector(`[data-label='${type}.${field}']`);
          if (labelElement && labels[field]) {
            labelElement.textContent = labels[field];
          }
          const fieldElement = document.querySelector(`[data-field='${type}.${field}']`);
          if (
            fieldElement &&
            fieldElement.tagName === "INPUT" &&
            field !== "country" &&
            placeholders[field]
          ) {
            fieldElement.placeholder = placeholders[field];
          }
        });
        const postalInput = document.querySelector(`[data-field='${type}.postalCode']`);
        if (postalInput) {
          if (config.postalPattern) {
            postalInput.setAttribute("pattern", config.postalPattern);
          } else {
            postalInput.removeAttribute("pattern");
          }
          if (config.postalInputMode) {
            postalInput.setAttribute("inputmode", config.postalInputMode);
          } else {
            postalInput.removeAttribute("inputmode");
          }
        }
        const stateContainer = document.querySelector(`[data-field-container='${type}.state']`);
        if (stateContainer) {
          stateContainer.hidden = !config.showState;
        }
        const stateInput = document.querySelector(`[data-field='${type}.state']`);
        if (stateInput) {
          if (placeholders.state !== undefined) {
            stateInput.placeholder = placeholders.state;
          }
          if (config.requireState) {
            stateInput.setAttribute("required", "required");
          } else {
            stateInput.removeAttribute("required");
          }
        }
        const taxInput = document.querySelector(`[data-field='${type}.nip']`);
        if (taxInput) {
          if (config.code === "USA") {
            taxInput.setAttribute("pattern", "^\\d{2}-\\d{7}$");
            taxInput.setAttribute("inputmode", "numeric");
          } else if (config.code === "POL") {
            taxInput.setAttribute("pattern", "^\\d{10}$");
            taxInput.setAttribute("inputmode", "numeric");
          } else {
            taxInput.removeAttribute("pattern");
            taxInput.removeAttribute("inputmode");
          }
        }
        if (type === "seller") {
          const bankContainer = document.querySelector(`[data-field-container='${type}.bankAccount']`);
          if (bankContainer) {
            bankContainer.hidden = !config.showBankAccount;
          }
        }
      }

      function setNested(path, value) {
        const keys = path.split(".");
        let target = state;
        keys.forEach((key, index) => {
          if (index === keys.length - 1) {
            target[key] = value;
          } else {
            target = target[key];
          }
        });
        renderPreview();
      }

      function handleFieldChange(event) {
        const path = event.target.dataset.field;
        if (!path) return;
        const { type, value } = event.target;

        if (path === "exchangeRate.targetDate") {
          if (event.type === "input") {
            return;
          }
          const sanitized = sanitizeRateDate(value);
          if (exchangeRateDateInput && exchangeRateDateInput.value !== sanitized) {
            exchangeRateDateInput.value = sanitized;
          }
          setNested(path, sanitized);
          state.exchangeRate.effectiveDate = "";
          state.exchangeRate.value = null;
          updateExchangeRateUI();
          if (sanitized) {
            ensureExchangeRate({ forceRefresh: true });
          } else {
            renderPreview();
          }
          return;
        }

        if (path === "issueDate") {
          const previousIssueDate = state.issueDate;
          setNested(path, value);
          const normalizedCurrency = (state.currency || "").trim().toUpperCase();
          if (normalizedCurrency && normalizedCurrency !== "PLN") {
            const previousDefault = getPreviousBusinessDay(previousIssueDate);
            const targetWasDefault =
              !state.exchangeRate.targetDate ||
              state.exchangeRate.targetDate === previousDefault;
            if (targetWasDefault) {
              state.exchangeRate.targetDate = getPreviousBusinessDay(value);
              state.exchangeRate.effectiveDate = "";
              state.exchangeRate.value = null;
              updateExchangeRateUI();
              ensureExchangeRate({ forceRefresh: true });
              return;
            }
          }
          updateExchangeRateUI();
          return;
        }

        if (path === "currency") {
          const normalized = String(value ?? "").trim().toUpperCase();
          setNested(path, normalized);
          handleCurrencyChange();
          return;
        }

        const [rootKey, ...segments] = path.split(".");
        const fieldKey = segments.join(".");
        if (
          (rootKey === "seller" || rootKey === "buyer") &&
          fieldKey === "country"
        ) {
          const normalized = normalizeCountry(value);
          state[rootKey].country = normalized;
          event.target.value = normalized;
          applyCountryFormatting(rootKey);
          updatePartyForm(rootKey);
          renderPreview();
          return;
        }

        let parsedValue =
          type === "number" ? parseFloat(value) || 0 : value;

        if (rootKey === "seller" || rootKey === "buyer") {
          const country = state[rootKey]?.country;
          if (fieldKey === "postalCode") {
            parsedValue = formatPostalCode(parsedValue, country);
            setNested(path, parsedValue);
            event.target.value = parsedValue;
            return;
          }
          if (fieldKey === "state") {
            parsedValue = formatStateValue(parsedValue, country);
            setNested(path, parsedValue);
            event.target.value = parsedValue;
            return;
          }
          if (fieldKey === "nip") {
            parsedValue = formatTaxId(parsedValue, country);
            setNested(path, parsedValue);
            event.target.value = parsedValue;
            return;
          }
        }

        setNested(path, parsedValue);

      }

      function handleCurrencyChange() {
        const normalizedCurrency = (state.currency || "").trim().toUpperCase();
        state.currency = normalizedCurrency;
        if (!normalizedCurrency || normalizedCurrency === "PLN") {
          state.exchangeRate = { targetDate: "", effectiveDate: "", value: null };
          rateStatus = { loading: false, error: null };
          updateExchangeRateUI();
          renderPreview();
          return;
        }

        state.exchangeRate.targetDate =
          state.exchangeRate.targetDate || getPreviousBusinessDay(state.issueDate);
        state.exchangeRate.effectiveDate = "";
        state.exchangeRate.value = null;
        updateExchangeRateUI();
        ensureExchangeRate({ forceRefresh: true });
      }

      function addItem() {
        const ids = state.items.map((item) => Number(item.id));
        const next = ids.length ? Math.max(...ids) + 1 : 1;
        state.items.push({
          id: String(next),
          name: "",
          quantity: 1,
          unit: "szt.",
          netPrice: 0,
          vatRate: 23,
        });
        renderItems();
        renderPreview();
      }

      function updateItem(id, field, value) {
        const item = state.items.find((entry) => entry.id === id);
        if (!item) return;
        if (["quantity", "netPrice", "vatRate"].includes(field)) {
          item[field] = parseFloat(value) || 0;
        } else {
          item[field] = value;
        }
        renderPreview();
      }

      function removeItem(id) {
        if (state.items.length === 1) {
          alert("Faktura musi miec przynajmniej jedna pozycje.");
          return;
        }
        state.items = state.items.filter((item) => item.id !== id);
        renderItems();
        renderPreview();
      }

      function renderItems() {
        itemsContainer.innerHTML = "";
        state.items.forEach((item, index) => {
          const fragment = itemTemplate.content.cloneNode(true);
          const card = fragment.querySelector("[data-card]");
          card.dataset.id = item.id;
          fragment.querySelector("[data-index]").textContent = index + 1;
          fragment.querySelector("[data-item='name']").value = item.name || "";
          fragment.querySelector("[data-item='quantity']").value =
            item.quantity;
          fragment.querySelector("[data-item='unit']").value = item.unit || "";
          fragment.querySelector("[data-item='netPrice']").value =
            item.netPrice;
          fragment.querySelector("[data-item='vatRate']").value = item.vatRate;

          fragment.querySelectorAll("[data-item]").forEach((input) => {
            input.addEventListener("input", (event) =>
              updateItem(
                item.id,
                event.target.dataset.item,
                event.target.value
              )
            );
          });
          fragment
            .querySelector("[data-remove]")
            .addEventListener("click", () => removeItem(item.id));
          itemsContainer.appendChild(fragment);
        });
      }

      function formatCurrency(amount, currency = state.currency) {
        const symbols = { PLN: "zl", EUR: "EUR", USD: "USD", GBP: "GBP" };
        return `${amount.toFixed(2)} ${symbols[currency] || currency}`;
      }

      function isPercentageRate(rate) {
        return Number(rate) >= 0;
      }

      function calculateVatAmount(rate, net) {
        return isPercentageRate(rate) ? (net * rate) / 100 : 0;
      }

      function getVatLabel(rate) {
        if (isPercentageRate(rate)) {
          return `${rate}%`;
        }
        switch (Number(rate)) {
          case -1:
            return "ZW";
          case -2:
            return "NP";
          case -3:
            return "OO";
          default:
            return "ZW";
        }
      }

      function formatDate(value) {
        if (!value) return "";
        try {
          return new Date(value).toLocaleDateString("pl-PL");
        } catch (error) {
          return value;
        }
      }

      function calculateTotals() {
        const summary = {};
        state.items.forEach((item) => {
          const net = item.quantity * item.netPrice;
          const vat = calculateVatAmount(item.vatRate, net);
          const gross = net + vat;
          summary[item.vatRate] ??= { net: 0, vat: 0, gross: 0 };
          summary[item.vatRate].net += net;
          summary[item.vatRate].vat += vat;
          summary[item.vatRate].gross += gross;
        });
        const netTotal = Object.values(summary).reduce(
          (sum, row) => sum + row.net,
          0
        );
        const vatTotal = Object.values(summary).reduce(
          (sum, row) => sum + row.vat,
          0
        );
        return {
          netTotal,
          vatTotal,
          grossTotal: netTotal + vatTotal,
          rows: Object.entries(summary).map(([rate, values]) => ({
            rate: Number(rate),
            ...values,
          })),
        };
      }

      function renderPreview() {
        const totals = calculateTotals();
        const showPlnBreakdown =
          state.currency !== "PLN" && typeof state.exchangeRate.value === "number";
        const rateValue = showPlnBreakdown ? state.exchangeRate.value : 0;
        const plnTotals = showPlnBreakdown
          ? {
              net: totals.netTotal * rateValue,
              vat: totals.vatTotal * rateValue,
              gross: totals.grossTotal * rateValue,
            }
          : null;
        const plnRowsHtml = showPlnBreakdown
          ? state.items
              .map((item, index) => {
                const net = item.quantity * item.netPrice;
                const vat = calculateVatAmount(item.vatRate, net);
                const gross = net + vat;
                const vatLabel = getVatLabel(item.vatRate);
                return `
                  <tr>
                    <td class="num" style="width:5%;">${index + 1}</td>
                    <td style="width:34%;word-break:break-word;">${item.name || "-"}</td>
                    <td class="num" style="width:7%;">${item.quantity.toFixed(2)}</td>
                    <td style="width:5%;">${item.unit || ""}</td>
                    <td class="num" style="width:12%;">${formatCurrency(item.netPrice * rateValue, "PLN")}</td>
                    <td class="num" style="width:12%;">${formatCurrency(net * rateValue, "PLN")}</td>
                    <td class="num" style="width:5%;">${vatLabel}</td>
                    <td class="num" style="width:10%;">${formatCurrency(vat * rateValue, "PLN")}</td>
                    <td class="num" style="width:10%;">${formatCurrency(gross * rateValue, "PLN")}</td>
                  </tr>
                `;
              })
              .join("")
          : "";
        const plnSummaryHtml = showPlnBreakdown
          ? `
          <div class="summary" style="margin-top:14px;">
            <div class="summary-heading">Przeliczenie pozycji na PLN</div>
            <p class="exchange-rate-muted" style="margin:4px 0 8px;font-size:0.55rem;line-height:1.35;">
              Kurs sredni NBP (tabela A) z dnia ${
                state.exchangeRate.effectiveDate || state.exchangeRate.targetDate || "-"
              }: ${state.exchangeRate.value.toFixed(4)} PLN${
              state.exchangeRate.targetDate &&
              state.exchangeRate.effectiveDate &&
              state.exchangeRate.targetDate !== state.exchangeRate.effectiveDate
                ? ` (wybrana data: ${state.exchangeRate.targetDate})`
                : ""
            }.
            </p>
            <table style="margin-top:8px;margin-bottom:10px;">
              <thead>
                <tr>
                  <th style="width:40px;">Lp.</th>
                  <th style="width:34%;">Nazwa</th>
                  <th style="width:7%;">Ilosc</th>
                  <th style="width:5%;">Jedn.</th>
                  <th style="width:12%;">Cena netto (PLN)</th>
                  <th style="width:12%;">Wartosc netto (PLN)</th>
                  <th style="width:5%;">VAT</th>
                  <th style="width:10%;">Kwota VAT (PLN)</th>
                  <th style="width:10%;">Wartosc brutto (PLN)</th>
                </tr>
              </thead>
              <tbody>
                ${
                  plnRowsHtml ||
                  `<tr><td colspan="9" style="text-align:center;padding:18px;">Brak pozycji</td></tr>`
                }
              </tbody>
            </table>
            <div class="totals-grid">
              <div class="totals-card">
                <p class="totals-label">Suma netto (PLN)</p>
                <p class="totals-value">${formatCurrency(plnTotals.net, "PLN")}</p>
              </div>
              <div class="totals-card">
                <p class="totals-label">Suma VAT (PLN)</p>
                <p class="totals-value">${formatCurrency(plnTotals.vat, "PLN")}</p>
              </div>
              <div class="totals-card totals-card--highlight">
                <p class="totals-label">Suma brutto (PLN)</p>
                <p class="totals-value">${formatCurrency(plnTotals.gross, "PLN")}</p>
              </div>
            </div>
          </div>
        `
          : "";
        preview.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
            <div>
              <h2 style="font-size:1.2rem;margin:0 0 4px;">Faktura VAT</h2>
              <p style="margin:0;color:${state.invoiceNumber ? "#1f2937" : "#9ca3af"};">
                ${state.invoiceNumber || "Numer faktury"}
              </p>
            </div>
            ${
              state.logo
                ? `<img src="${state.logo}" alt="Logo" style="max-height:60px;max-width:140px;object-fit:contain;" />`
                : ""
            }
          </div>
          <div class="pair">
            <div class="info-box">
              <h3>Sprzedawca</h3>
              <p>
                ${buildPartyPreviewHtml(state.seller, "seller")}
              </p>
            </div>
            <div class="info-box">
              <h3>Nabywca</h3>
              <p>
                ${buildPartyPreviewHtml(state.buyer, "buyer")}
              </p>
            </div>
          </div>
          <div class="details-grid">
            <div>
              <p class="details-label">Data wystawienia</p>
              <p class="details-value">${formatDate(state.issueDate) || "brak"}</p>
            </div>
            <div>
              <p class="details-label">Data sprzedazy</p>
              <p class="details-value">${formatDate(state.saleDate) || "brak"}</p>
            </div>
            <div>
              <p class="details-label">Termin platnosci</p>
              <p class="details-value">${formatDate(state.paymentDeadline) || "brak"}</p>
            </div>
            <div>
              <p class="details-label">Metoda platnosci</p>
              <p class="details-value">${state.paymentMethod || "brak"}</p>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:40px;">Lp.</th>
                <th style="width:34%;">Nazwa</th>
                <th style="width:7%;">Ilosc</th>
                <th style="width:5%;">Jedn.</th>
                <th style="width:12%;">Cena netto</th>
                <th style="width:12%;">Wartosc netto</th>
                <th style="width:5%;">VAT</th>
                <th style="width:10%;">Kwota VAT</th>
                <th style="width:10%;">Wartosc brutto</th>
              </tr>
            </thead>
            <tbody>
              ${
                state.items.length
                  ? state.items
                      .map((item, index) => {
                        const net = item.quantity * item.netPrice;
                        const vat = calculateVatAmount(item.vatRate, net);
                        const gross = net + vat;
                        const vatLabel = getVatLabel(item.vatRate);
                        return `
                          <tr>
                            <td class="num" style="width:5%;">${index + 1}</td>
                            <td style="width:34%;word-break:break-word;">${item.name || "-"}</td>
                            <td class="num" style="width:7%;">${item.quantity.toFixed(2)}</td>
                            <td style="width:5%;">${item.unit || ""}</td>
                            <td class="num" style="width:12%;">${formatCurrency(item.netPrice)}</td>
                            <td class="num" style="width:12%;">${formatCurrency(net)}</td>
                            <td class="num" style="width:5%;">${vatLabel}</td>
                            <td class="num" style="width:10%;">${formatCurrency(vat)}</td>
                            <td class="num" style="width:10%;">${formatCurrency(gross)}</td>
                          </tr>
                        `;
                      })
                      .join("")
                  : `<tr><td colspan="9" style="text-align:center;padding:18px;">Brak pozycji</td></tr>`
              }
            </tbody>
          </table>
          <div class="totals-grid">
            <div class="totals-card">
              <p class="totals-label">Suma netto</p>
              <p class="totals-value">${formatCurrency(totals.netTotal)}</p>
            </div>
            <div class="totals-card">
              <p class="totals-label">Suma VAT</p>
              <p class="totals-value">${formatCurrency(totals.vatTotal)}</p>
            </div>
            <div class="totals-card totals-card--highlight">
              <p class="totals-label">Suma brutto</p>
              <p class="totals-value">${formatCurrency(totals.grossTotal)}</p>
            </div>
          </div>
          <div class="summary" style="margin-top:16px;">
            <div class="summary-heading">Zestawienie VAT</div>
            <table>
              <thead>
                <tr>
                  <th>Stawka</th>
                  <th>Netto</th>
                  <th>VAT</th>
                  <th>Brutto</th>
                </tr>
              </thead>
              <tbody>
                ${
                  totals.rows.length
                    ? totals.rows
                        .map(
                          (row) => `
                            <tr>
                              <td>${getVatLabel(row.rate)}</td>
                              <td class="num">${formatCurrency(row.net)}</td>
                              <td class="num">${formatCurrency(row.vat)}</td>
                              <td class="num">${formatCurrency(row.gross)}</td>
                            </tr>
                          `
                        )
                        .join("")
                    : `<tr><td colspan="4" style="text-align:center;padding:12px;">Brak danych</td></tr>`
                }
              </tbody>
            </table>
          </div>
          ${plnSummaryHtml}
          <div class="notes">
            <strong>Uwagi:</strong><br/>
            ${state.notes ? state.notes.replace(/\n/g, "<br/>") : "Brak"}
          </div>
        `;
      }

      function populateCompanySelect(type) {
        const select = document.getElementById(`${type}-select`);
        const current = select.value;
        const entries = Object.keys(storedData[type] || {});
        select.innerHTML = '<option value="">Wybierz zapisane dane</option>';
        entries.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        if (current && entries.includes(current)) {
          select.value = current;
        }
      }

      function saveCompany(type) {
        const data = clone(state[type]);
        if (!data.name) {
          alert("Podaj nazwe firmy, aby zapisac dane.");
          return;
        }
        storedData[type][data.name] = clone(data);
        persistStorage();
        populateCompanySelect(type);
        document.getElementById(`${type}-select`).value = data.name;
        syncForm();
        renderPreview();
        alert("Dane zapisane.");
      }

      function importCompanies() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.addEventListener("change", (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          if (!file) return;

          const reader = new FileReader();
          reader.onload = () => {
            try {
              const parsed = JSON.parse(reader.result);
              if (!parsed || typeof parsed !== "object") {
                throw new Error("Nieprawidlowy format JSON.");
              }

              const summary = mergeImportedData(parsed);
              persistStorage();
              populateCompanySelect("seller");
              populateCompanySelect("buyer");

              let shouldRefresh = false;

              if (summary.sellerImported) {
                if (state.seller.name && storedData.seller[state.seller.name]) {
                  state.seller = clone(storedData.seller[state.seller.name]);
                  document.getElementById("seller-select").value = state.seller.name;
                } else {
                  const firstSeller = Object.keys(storedData.seller)[0];
                  if (firstSeller) {
                    state.seller = clone(storedData.seller[firstSeller]);
                    document.getElementById("seller-select").value = firstSeller;
                  }
                }
                shouldRefresh = true;
              } else if (!state.seller.name) {
                const firstSeller = Object.keys(storedData.seller)[0];
                if (firstSeller) {
                  state.seller = clone(storedData.seller[firstSeller]);
                  document.getElementById("seller-select").value = firstSeller;
                  shouldRefresh = true;
                }
              }

              if (summary.buyerImported) {
                if (state.buyer.name && storedData.buyer[state.buyer.name]) {
                  state.buyer = clone(storedData.buyer[state.buyer.name]);
                  document.getElementById("buyer-select").value = state.buyer.name;
                } else {
                  const firstBuyer = Object.keys(storedData.buyer)[0];
                  if (firstBuyer) {
                    state.buyer = clone(storedData.buyer[firstBuyer]);
                    document.getElementById("buyer-select").value = firstBuyer;
                  }
                }
                shouldRefresh = true;
              } else if (!state.buyer.name) {
                const firstBuyer = Object.keys(storedData.buyer)[0];
                if (firstBuyer) {
                  state.buyer = clone(storedData.buyer[firstBuyer]);
                  document.getElementById("buyer-select").value = firstBuyer;
                  shouldRefresh = true;
                }
              }

              if (shouldRefresh) {
                syncForm();
                renderPreview();
              }

              const message =
                summary.sellerImported || summary.buyerImported
                  ? `Zaimportowano: ${summary.sellerImported} sprzedawca, ${summary.buyerImported} nabywca.`
                  : "Brak nowych danych do importu.";
              alert(message);
            } catch (error) {
              console.error(error);
              alert("Nieprawidlowy plik JSON.");
            }
          };
          reader.readAsText(file);
        });
        input.click();
      }

      function mergeImportedData(data) {
        let sellerImported = 0;
        let buyerImported = 0;

        if (data.seller || data.buyer) {
          if (data.seller && typeof data.seller === "object") {
            const sellerEntries = Array.isArray(data.seller)
              ? data.seller.map((entry) => [entry?.name || "", entry])
              : Object.entries(data.seller);
            sellerEntries.forEach(([name, entry]) => {
              const mapped = mapImportedCompany("seller", { ...entry, name: entry?.name || name });
              if (mapped.name) {
                storedData.seller[mapped.name] = mapped;
                sellerImported += 1;
              }
            });
          }
          if (data.buyer && typeof data.buyer === "object") {
            const buyerEntries = Array.isArray(data.buyer)
              ? data.buyer.map((entry) => [entry?.name || "", entry])
              : Object.entries(data.buyer);
            buyerEntries.forEach(([name, entry]) => {
              const mapped = mapImportedCompany("buyer", { ...entry, name: entry?.name || name });
              if (mapped.name) {
                storedData.buyer[mapped.name] = mapped;
                buyerImported += 1;
              }
            });
          }
        } else if (data.name) {
          const inferredType =
            data.account || data.bankAccount || data.bank_account ? "seller" : "buyer";
          const mapped = mapImportedCompany(inferredType, data);
          if (mapped.name) {
            storedData[inferredType][mapped.name] = mapped;
            if (inferredType === "seller") {
              sellerImported += 1;
            } else {
              buyerImported += 1;
            }
          }
        } else {
          throw new Error("Nieprawidlowy format JSON.");
        }

        return { sellerImported, buyerImported };
      }

      function mapImportedCompany(type, data) {
        return normalizePartyRecord(
          {
            ...data,
            name: (data?.name || "").toString().trim(),
          },
          type
        );
      }

      function handleSelectChange(type) {
        const select = document.getElementById(`${type}-select`);
        const entry = storedData[type][select.value];
        if (!entry) {
          state[type] = clone(defaultState[type]);
          syncForm();
          renderPreview();
          return;
        }
        state[type] = clone(entry);
        syncForm();
        renderPreview();
      }

      function exportData() {
        const payload = { seller: {}, buyer: {} };

        Object.entries(storedData.seller).forEach(([name, record]) => {
          if (!record) return;
          const normalized = normalizePartyRecord(record, "seller");
          const entry = {
            name: normalized.name || name,
            nip: normalized.nip || "",
            address: buildExportAddress(normalized),
            postalCode: normalized.postalCode || "",
            city: normalized.city || "",
            state: normalized.state || "",
            country: normalized.country,
          };
          if (normalized.bankAccount) {
            entry.account = normalized.bankAccount;
          }
          payload.seller[name] = entry;
        });

        Object.entries(storedData.buyer).forEach(([name, record]) => {
          if (!record) return;
          const normalized = normalizePartyRecord(record, "buyer");
          payload.buyer[name] = {
            name: normalized.name || name,
            nip: normalized.nip || "",
            address: buildExportAddress(normalized),
            postalCode: normalized.postalCode || "",
            city: normalized.city || "",
            state: normalized.state || "",
            country: normalized.country,
          };
        });

        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "eksport.json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function buildExportAddress(record) {
        if (!record) return "";
        const normalized = normalizePartyRecord(record, "buyer");
        const parts = [];
        if (normalized.address) {
          parts.push(normalized.address);
        }
        const location = formatPartyLocation(normalized);
        if (location) {
          parts.push(location);
        }
        const countryLine = formatPartyCountryLine(normalized);
        if (countryLine) {
          parts.push(countryLine);
        }
        return parts.join(", ").replace(/\s+/g, " ").trim();
      }

      function syncForm() {
        applyCountryFormatting("seller");
        applyCountryFormatting("buyer");
        document.querySelectorAll("[data-field]").forEach((input) => {
          const path = input.dataset.field;
          const keys = path.split(".");
          let value = state;
          keys.forEach((key) => (value = value[key]));
          if (input.type === "date") {
            input.value = value ? value : "";
          } else {
            input.value = value ?? "";
          }
        });
        updatePartyForm("seller");
        updatePartyForm("buyer");
        const sellerSelect = document.getElementById("seller-select");
        const buyerSelect = document.getElementById("buyer-select");
        if (sellerSelect) {
          sellerSelect.value = state.seller.name || "";
        }
        if (buyerSelect) {
          buyerSelect.value = state.buyer.name || "";
        }
        renderItems();
        renderLogo();
        updateExchangeRateUI();
      }

      function renderLogo() {
        if (state.logo) {
          logoPreview.innerHTML = `<img src="${state.logo}" alt="Logo firmy" />`;
        } else {
          logoPreview.textContent = "Brak logo";
        }
      }

      function handleLogo(file) {
        const reader = new FileReader();
        reader.onloadend = () => {
          state.logo = reader.result;
          renderLogo();
          renderPreview();
        };
        reader.readAsDataURL(file);
      }

      function downloadInvoice() {
        const previewElement = document.getElementById("preview");
        if (!previewElement) {
          return;
        }

        const iframe = document.createElement("iframe");
        iframe.style.position = "fixed";
        iframe.style.right = "0";
        iframe.style.bottom = "0";
        iframe.style.width = "0";
        iframe.style.height = "0";
        iframe.style.border = "0";
        iframe.style.visibility = "hidden";
        document.body.appendChild(iframe);

        const iframeWindow = iframe.contentWindow;
        const iframeDocument = iframeWindow?.document;

        if (!iframeWindow || !iframeDocument) {
          iframe.remove();
          return;
        }

        iframeDocument.open();
        iframeDocument.write("<!DOCTYPE html><html lang='pl'><head></head><body></body></html>");

        document
          .querySelectorAll("style, link[rel='stylesheet']")
          .forEach((node) => iframeDocument.head.appendChild(node.cloneNode(true)));

        const printStyles = iframeDocument.createElement("style");
        printStyles.textContent = `
          @page { size: A4; margin: 0; }
          html, body { margin: 0; padding: 0; background: #f3f4f6; }
          body { display: flex; justify-content: center; align-items: flex-start; }
          #invoice-preview-print {
            width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            background: #ffffff;
            margin: 0 auto;
            box-shadow: none !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
        `;
        iframeDocument.head.appendChild(printStyles);

        iframeDocument.title = state.invoiceNumber
          ? `Faktura ${state.invoiceNumber}`
          : "Faktura";

        const clonedPreview = previewElement.cloneNode(true);
        clonedPreview.id = "invoice-preview-print";
        iframeDocument.body.appendChild(clonedPreview);
        iframeDocument.body.style.margin = "0";
        iframeDocument.body.style.backgroundColor = "#f3f4f6";
        iframeDocument.close();

        const cleanup = () => {
          iframeWindow.onafterprint = null;
          iframe.remove();
        };

        iframeWindow.onafterprint = cleanup;

        setTimeout(() => {
          iframeWindow.focus();
          iframeWindow.print();
          setTimeout(cleanup, 2000);
        }, 150);
      }

      function attachEvents() {
        document
          .querySelectorAll("[data-field]")
          .forEach((input) => {
            input.addEventListener("input", handleFieldChange);
            input.addEventListener("change", handleFieldChange);
          });
        document
          .getElementById("add-item")
          .addEventListener("click", addItem);
        document
          .getElementById("logo-btn")
          .addEventListener("click", () =>
            document.getElementById("logo-input").click()
          );
        document
          .getElementById("logo-input")
          .addEventListener("change", (event) => {
            const file = event.target.files?.[0];
            if (file) handleLogo(file);
          });

        document
          .getElementById("import-btn")
          .addEventListener("click", importCompanies);
        document
          .getElementById("export-btn")
          .addEventListener("click", exportData);

        const ratePrevButton = document.querySelector("[data-action='rate-prev-day']");
        if (ratePrevButton) {
          ratePrevButton.addEventListener("click", () => {
            state.exchangeRate.targetDate = getPreviousBusinessDay(state.issueDate);
            state.exchangeRate.effectiveDate = "";
            state.exchangeRate.value = null;
            updateExchangeRateUI();
            ensureExchangeRate({ forceRefresh: true });
          });
        }

        const rateRefreshButton = document.querySelector("[data-action='rate-refresh']");
        if (rateRefreshButton) {
          rateRefreshButton.addEventListener("click", () => {
            if (state.currency === "PLN") {
              return;
            }
            if (!state.exchangeRate.targetDate) {
              state.exchangeRate.targetDate = getPreviousBusinessDay(state.issueDate);
            }
            updateExchangeRateUI();
            ensureExchangeRate({ forceRefresh: true });
          });
        }

        document
          .querySelector("[data-action='save-seller']")
          .addEventListener("click", () => saveCompany("seller"));
        document
          .getElementById("seller-select")
          .addEventListener("change", () => handleSelectChange("seller"));

        document
          .querySelector("[data-action='save-buyer']")
          .addEventListener("click", () => saveCompany("buyer"));
        document
          .getElementById("buyer-select")
          .addEventListener("change", () => handleSelectChange("buyer"));

        document
          .getElementById("download-btn")
          .addEventListener("click", downloadInvoice);

        const notesField = document.querySelector("[data-field='notes']");
        document
          .querySelectorAll("[data-note]")
          .forEach((button) => {
            button.addEventListener("click", () => {
              if (!notesField) return;
              const note = button.dataset.note || "";
              if (!note) return;
              const current = notesField.value || "";
              if (current.includes(note)) {
                return;
              }
              const separator = current.trim().length ? "\n" : "";
              const updated = current + separator + note;
              notesField.value = updated;
              setNested("notes", updated);
            });
          });
      }

      function init() {
        if (!state.exchangeRate) {
          state.exchangeRate = { targetDate: "", effectiveDate: "", value: null };
        }
        if (!state.seller.name) {
          const firstSeller = Object.keys(storedData.seller)[0];
          if (firstSeller) {
            state.seller = clone(storedData.seller[firstSeller]);
          }
        }
        if (!state.buyer.name) {
          const firstBuyer = Object.keys(storedData.buyer)[0];
          if (firstBuyer) {
            state.buyer = clone(storedData.buyer[firstBuyer]);
          }
        }
        populateCompanySelect("seller");
        populateCompanySelect("buyer");
        syncForm();
        renderPreview();
        if (state.currency !== "PLN") {
          ensureExchangeRate();
        }
        attachEvents();
      }

      init();
    </script>
  </body>
</html>

